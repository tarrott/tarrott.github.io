<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Monitoring - Engineering Wiki</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Monitoring";
    var mkdocs_page_input_path = "architecture/monitoring.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Engineering Wiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">Architecture</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../highlevel_design/">High-level Design</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../linux/">Linux</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../virtualization/">Virtualization</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../cicd/">CICD</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Monitoring</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#live-metrics-stream">Live Metrics Stream</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#server-metrics">Server Metrics</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#optimization-game-plan">Optimization Game Plan</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#grafana">Grafana</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#centeralized-logging">Centeralized Logging</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#elk-stack">ELK Stack</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#configure-elasticsearch-stack-in-containers">Configure Elasticsearch stack in containers</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#logstash">Logstash</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#beats">Beats</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#kibana">Kibana</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-checks">Health Checks</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#correlation-token">Correlation Token</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../chaos_eng/">Chaos Engineering</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../homelab/">Homelab</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../case_studies/">Case Studies</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Software</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/computer_science/">Computer Science</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/data_structures/">Data Structures</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/algorithms/">Algorithms</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/design_patterns/">Design Patterns</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/best_practices/">Best Practices</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/oop/">OOP</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/functional_paradigm/">Functional Paradigm</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/python/">Python</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../software/guis/">GUIs</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Data</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../data/pipelines/">Data Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../data/analysis/">Data Analysis</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../data/machine_learning/">Machine Learning</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../data/big_data/">Big Data</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../data/storage/">Data Storage</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Math</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../math/linear_algebra/">Linear Algebra</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../math/statistics/">Statistics</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../math/calculus/">Calculus</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../design/">Design</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../resources/">Resources</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../wiki/">Wiki</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Engineering Wiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Architecture &raquo;</li>
        
      
    
    <li>Monitoring</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="monitoring">Monitoring</h1>
<p>The 3 pillars of Observability:</p>
<ul>
<li>Metrics<ul>
<li>Answers: "How has the system performance changed throughout time?"</li>
<li>numbers related to events that happened in a specifc time range</li>
<li>example technologies: Metricbeats or Prometheus with Grafana</li>
</ul>
</li>
<li>Logs<ul>
<li>Answers: "What is happening in the system?"</li>
<li>gives insights into a single events occuring in the system</li>
<li>example technologies: ELK stack</li>
</ul>
</li>
<li>Tracing<ul>
<li>Answers: "How are the system components interacting with each other?"</li>
<li>shows how long a specific request spent in the different system components</li>
<li>example technologies: Jaeger or Zipkin</li>
</ul>
</li>
</ul>
<hr />
<h2 id="live-metrics-stream">Live Metrics Stream</h2>
<ul>
<li>app</li>
<li>system</li>
<li>platform</li>
</ul>
<h3 id="server-metrics">Server Metrics</h3>
<ul>
<li>CPU Utilization</li>
<li>Memory Utilization</li>
<li>Network Utilization</li>
<li>Disk Performance and Read/Writes</li>
<li>Disk Space</li>
</ul>
<h3 id="optimization-game-plan">Optimization Game Plan</h3>
<ol>
<li>Run performance tests</li>
<li>Capture and analyze metrics</li>
<li>Select the optimal instance</li>
<li>Monitor for outliers to make sure the optimal instance continues to be optimal</li>
</ol>
<h3 id="grafana">Grafana</h3>
<hr />
<h2 id="centeralized-logging">Centeralized Logging</h2>
<h3 id="elk-stack">ELK Stack</h3>
<ul>
<li><a href="https://opendistro.github.io/for-elasticsearch/">Open Distro</a><ul>
<li>Apache 2.0 license</li>
<li>Security</li>
<li>Alerting</li>
<li>SQL</li>
<li>Performance Annalyzer (perftop CLI tool)</li>
</ul>
</li>
<li>Kubernetes Operator: Elastic Cloud on Kubernetes (ECK)<ul>
<li>uses the free tier Elasticsearch License</li>
</ul>
</li>
</ul>
<h4 id="configure-elasticsearch-stack-in-containers">Configure Elasticsearch stack in containers</h4>
<p><a href="https://github.com/deviantony/docker-elk">docker-compose quickstart repo</a></p>
<h6 id="increase-heap-size-allocate-more-memory-for-es-in-jvm-options">Increase heap size / allocate more memory for ES in JVM options:</h6>
<ul>
<li>Update environment variables in docker-compose file <code>- "ES_JAVA_OPTS=-Xms4g -Xmx4g"</code></li>
</ul>
<h6 id="modify-file-descriptors">Modify file descriptors:</h6>
<ul>
<li>File descriptors: "Make sure to increase the limit on the number of open files descriptors for the user running Elasticsearch to 65,536 or higher."</li>
<li>run everything as <code>root</code> user</li>
<li><code>ulimit -Hn</code>: 4096 -&gt; 1024000</li>
<li><code>vim /usr/lib/sysctl.d/elasticsearch.conf</code></li>
<li><code>vim /etc/security/limits/conf</code></li>
<li><code>restorecon /etc/security/limits.conf</code></li>
<li><code>reboot</code> system</li>
</ul>
<p>/usr/lib/sysctl.d/elasticsearch.conf</p>
<pre><code>fs.file-max = 512000
vm.max_map_count = 524288
vm.swappiness = 1
</code></pre>

<p>/etc/security/limits/conf</p>
<pre><code>*                soft    nofile         1024000
*                hard    nofile         1024000
*                soft    memlock        unlimited
*                hard    memlock        unlimited
elastic          soft    nofile         1024000
elastic          hard    nofile         1024000
elastic          soft    memlock        unlimited
elastic          hard    memlock        unlimited
root             soft    nofile         1024000
root             hard    nofile         1024000
root             soft    memlock        unlimited
root             hard    memlock        unlimited
</code></pre>

<h4 id="logstash">Logstash</h4>
<p>Install additional plugins: <code>/bin/logstash install logstash-input-jmx</code>
Run pipeline: <code>/bin/logstash.bat -f logstash-pipeline.conf --config.reload.automatic</code>
Test pipeline configuration: <code>/bin/logstash.bat -f logstash-pipeline.conf --config.test_and_exit</code>
Run as service on a windows server: use NSSM</p>
<h6 id="ingest-log-file">Ingest log file</h6>
<p>Log sample</p>
<pre><code>2020-04-21 20:52:15,173 WARN  | ActiveMQ Task-1 ()  | [NetworkConnector:?] Could not start network...
2020-04-21 20:52:15,360 INFO  | main ()  | [AbstractService:?] ...finished service destruction
2020-04-21 20:52:15,095 INFO  | pool-9-thread-1 ()  | [EventConsumer:?] Interrupted while waiting for event.
</code></pre>

<p>application-pipeline.conf</p>
<pre><code>input {
    file {
        path =&gt; &quot;E:/My_Application/Config/application.log&quot;
        type =&gt; &quot;log&quot;
        start_position =&gt; &quot;beginning&quot;
        sincedb_path =&gt; &quot;NUL&quot;
    }
}

filter {
    grok {
        match =&gt; { &quot;message&quot; =&gt; &quot;%{DATA:date} %{DATA:time} %{DATA:log_level} \| %{DATA:thread} \| \[%{DATA:service}\] %{GREEDYDATA:log_msg}&quot; }
        add_field =&gt; { &quot;timestamp&quot; =&gt; &quot;%{date} %{time}&quot;}
        remove_field =&gt; [ &quot;date&quot;, &quot;time&quot;]
    }

    if &quot;_grokparsefailure&quot; in [tags] {
        drop { }
    }

    date {
        match =&gt; [ &quot;timestamp&quot;, &quot;YYYY-MM-dd HH:mm:ss,SSS&quot;]
    }

    mutate {
        add_field =&gt; { &quot;application_name&quot; =&gt; &quot;MY_APPLICATION&quot;}
        remove_field =&gt; [ &quot;timestamp&quot; ]
    }
}

output {
    elasticsearch {
        hosts =&gt; &quot;0.0.0.0:9200&quot;
        user =&gt; &quot;user&quot;
        password =&gt; &quot;passwd&quot;
        index =&gt; &quot;test-index-%{+YYYY.MM.dd}&quot;
    }
}
</code></pre>

<h6 id="ingest-jmx-data">Ingest jmx data</h6>
<p>Requires a jmx.conf file defined in <code>path</code> in jmx input plugin</p>
<pre><code>input {
    jmx {
        path =&gt; &quot;C:/elk/logstash/jmx&quot;
        polling_frequency =&gt; 15
        type =&gt; &quot;jmx&quot;
    }
}
</code></pre>

<p>jmx.conf</p>
<pre><code>{
    &quot;host&quot;: &quot;localhost&quot;,
    &quot;port&quot;: 9000,
    &quot;queries&quot;: [
    {
        &quot;object_name&quot; : &quot;java.lang:type=Memory&quot;,
        &quot;object_alias&quot; : &quot;Memory&quot;
    }, {
        &quot;object_name&quot; : &quot;java.lang:type=Runtime&quot;,
        &quot;attributes&quot; : [ &quot;uptime&quot;, &quot;StartTime&quot; ],
        &quot;object_alias&quot; : &quot;Runtime&quot;
    }, {
        &quot;object_name&quot; : &quot;java.lang:type=GarbageCollector,name=*&quot;,
        &quot;attributes&quot; : [ &quot;CollectionCount&quot;, &quot;CollectionTime&quot; ],
        &quot;object_alias&quot; : &quot;${type}.${name}&quot;
    }, {
        &quot;object_name&quot; : &quot;java.nio:type=BufferPool,name=*&quot;,
        &quot;object_alias&quot; : &quot;${type}.${name}&quot;
    }]
}
</code></pre>

<h4 id="beats">Beats</h4>
<h6 id="filebeat">Filebeat</h6>
<p>Example: send docker container logs to logstash</p>
<pre><code>filebeat.inputs:
- type: docker
  containers.path: /usr/share/dockerlogs/data
  containers.ids:
    - '1fb97e7e06677bc9c2aa2cee28b9a2e489a7c8ead62829d10a69e60e38d27310'
  #ignore_decoding_error: true
  json.message_key: log
  json.keys_under_root: true
  #exclude_lines: ['^\n']
  multiline.pattern: '^\s'
  multiline.match: after

processors:
  - add_docker_metadata:
      host: &quot;unix:///var/run/docker.sock&quot;
  - timestamp:
      field: time
      layouts:
        - '2020-02-12T06:59:01.944972082Z'

filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false

output.logstash:
  hosts: [&quot;172.18.1.200:5000&quot;]

logging.to_files: true
logging.to_syslog: false
</code></pre>

<h4 id="kibana">Kibana</h4>
<h6 id="jmx-example">JMX Example</h6>
<ol>
<li>Line chart visualization</li>
<li>Y-axis: Average</li>
<li>X-axis: Date Histogram</li>
<li>Split series <code>Filters</code> aggregation bucket: <code>metric_path:jvm.Memory.HeapMemoryUsage.used</code></li>
</ol>
<hr />
<h2 id="health-checks">Health Checks</h2>
<hr />
<h2 id="correlation-token">Correlation Token</h2>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../security/" class="btn btn-neutral float-right" title="Security">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cicd/" class="btn btn-neutral" title="CICD"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../cicd/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../security/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
